pipeline {
    agent any

    parameters {
        string(name: 'BRANCH', defaultValue: 'main', description: 'Git branch to build')
        choice(name: 'DEPLOY_METHOD', choices: ['MANAGER_API', 'LOCAL_COPY'], description: 'Select deployment method')
    }

    environment {
        // Application / deployment specifics
        APP_NAME          = 'virtual-event-management'
        TOMCAT_HOST       = 'localhost'
        TOMCAT_PORT       = '8080'
        TOMCAT_MANAGER_URL = "http://${TOMCAT_HOST}:${TOMCAT_PORT}/manager/text"

        // Local Tomcat webapps directory (adjust if different)
        WEBAPPS_DIR       = '/opt/tomcat/webapps'

        // Jenkins base URL (useful for notifications, links)
        JENKINS_BASE      = 'http://localhost:8888'

        MAVEN_OPTS        = '-Xms256m -Xmx512m'
    }

    options {
        buildDiscarder(logRotator(numToKeepStr: '25'))
        ansiColor('xterm')
        timestamps()
    }

    triggers {
        // Enable if using SCM polling instead of GitHub webhook:
        // pollSCM('H/15 * * * *')
    }

    stages {

        stage('Checkout') {
            steps {
                echo "Checking out branch: ${params.BRANCH}"
                git branch: params.BRANCH, url: 'https://github.com/archanareddyse/Virtual-Event-Management-Application.git'
            }
        }

        stage('Build Info') {
            steps {
                script {
                    echo "Jenkins Base URL: ${env.JENKINS_BASE}"
                    echo "Build URL: ${env.JENKINS_BASE}/job/${env.JOB_NAME}/${env.BUILD_NUMBER}/"
                    echo "Workspace: ${env.WORKSPACE}"
                }
            }
        }

        stage('Validate Build Tool') {
            steps {
                script {
                    if (!fileExists('pom.xml')) {
                        error """
pom.xml not found.
Add a Maven build file or convert this Jenkinsfile for Gradle usage.
"""
                    }
                }
            }
        }

        stage('Compile') {
            steps {
                sh 'mvn -B -U clean compile'
            }
        }

        stage('Unit Tests') {
            steps {
                sh 'mvn -B test'
            }
            post {
                always {
                    junit 'target/surefire-reports/*.xml'
                }
            }
        }

        stage('Package WAR') {
            steps {
                sh 'mvn -B package'
            }
            post {
                success {
                    script {
                        def warFile = "target/${APP_NAME}.war"
                        if (fileExists(warFile)) {
                            echo "WAR built: ${warFile}"
                        } else {
                            echo "Expected WAR (target/${APP_NAME}.war) missing. Listing target/ contents:"
                            sh 'ls -l target/'
                        }
                    }
                    archiveArtifacts artifacts: 'target/*.war', fingerprint: true
                }
            }
        }

        stage('Deploy via Manager API') {
            when {
                allOf {
                    expression { params.DEPLOY_METHOD == 'MANAGER_API' }
                    expression { fileExists("target/${APP_NAME}.war") }
                }
            }
            steps {
                withCredentials([usernamePassword(credentialsId: 'tomcat-manager-creds', usernameVariable: 'TC_USER', passwordVariable: 'TC_PASS')]) {
                    sh """
                    set -e
                    echo "Attempting undeploy (ignore errors if not present)..."
                    curl -s -u $TC_USER:$TC_PASS "${TOMCAT_MANAGER_URL}/undeploy?path=/${APP_NAME}" || true

                    echo "Deploying new WAR via Tomcat Manager..."
                    curl -u $TC_USER:$TC_PASS -T target/${APP_NAME}.war \
                      "${TOMCAT_MANAGER_URL}/deploy?path=/${APP_NAME}&update=true"

                    echo "Deployment request sent to Tomcat Manager."
                    """
                }
            }
        }

        stage('Deploy via Local Copy') {
            when {
                allOf {
                    expression { params.DEPLOY_METHOD == 'LOCAL_COPY' }
                    expression { fileExists("target/${APP_NAME}.war") }
                }
            }
            steps {
                script {
                    if (!fileExists(env.WEBAPPS_DIR)) {
                        error "WEBAPPS_DIR (${env.WEBAPPS_DIR}) does not exist or Jenkins cannot access it."
                    }
                }
                sh """
                set -e
                echo "Copying WAR to ${WEBAPPS_DIR}"
                cp -f target/${APP_NAME}.war ${WEBAPPS_DIR}/${APP_NAME}.war
                echo "WAR copied. Tomcat should auto-extract shortly."
                """
            }
        }

        stage('Smoke Test') {
            steps {
                script {
                    echo "Waiting briefly for app expansion..."
                    sleep 5
                }
                sh """
                set -e
                echo "Performing HTTP smoke test..."
                curl -f -I http://${TOMCAT_HOST}:${TOMCAT_PORT}/${APP_NAME}/ || (echo "Smoke test failed" && exit 1)
                echo "Smoke test succeeded."
                """
            }
        }
    }

    post {
        success {
            echo "SUCCESS: App available at http://${TOMCAT_HOST}:${TOMCAT_PORT}/${APP_NAME}/"
            echo "Build details: ${env.JENKINS_BASE}/job/${env.JOB_NAME}/${env.BUILD_NUMBER}/"
        }
        failure {
            echo "FAILURE: Review console output above."
            echo "Build details: ${env.JENKINS_BASE}/job/${env.JOB_NAME}/${env.BUILD_NUMBER}/"
        }
        always {
            cleanWs()
        }
    }
}